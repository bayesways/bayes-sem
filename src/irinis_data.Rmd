---
title: "Irini's Data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library('dplyr')
library('readr')
library('readxl')
library('tidyr')
library('stringr')
library('forcats')
```



## R Markdown

```{r}
df1 <- read_excel("../dat/Forms.xlsx", sheet = "form1", na = 'NA')
item_columns <- paste0('iraw.', seq(1:170))
dur_columns <- paste0('idur.', seq(1:170))

dfres_all<- df1 %>%
  select('Flagged', item_columns) %>%
  rename(subj_flag = 'Flagged') %>%
  mutate(subj_id = 1:n()) %>%
  gather(item_id,  res, -subj_flag, -subj_id) %>%
  select(subj_id, everything()) %>%
  mutate(item_id = str_replace(item_id, 'iraw.', ''))

```

Find subjects that answered at least one item at zero response time. 

```{r}
dfdur<- df1 %>%
  select('Flagged', dur_columns) %>%
  rename(subj_flag = 'Flagged') %>%
  mutate(subj_id = 1:n()) %>%
  gather(item_id,  dur, -subj_flag, -subj_id) %>%
  select(subj_id, everything()) %>%
  mutate(item_id = str_replace(item_id, 'idur.', ''))

zero_respone<- dfdur  %>% 
  filter(dur == 0) %>%
  distinct(subj_id) %>%
  arrange(subj_id)

zero_respone_subj_ids <- zero_respone$subj_id
```

filter out any data of subjects that had at least one zero-time response
```{r}
dfres <- dfres_all %>%
  filter(!subj_id %in% zero_respone_subj_ids)
```

arrange subjects by flag 

```{r}
clean_subj_df <- dfres %>% filter(subj_flag == 0) %>% distinct(subj_id)
clean_subj <- unique(clean_subj_df$subj_id)


flagged_subj_df <- dfres %>% filter(subj_flag == 1) %>% distinct(subj_id)
flagged_subj <- unique(flagged_subj_df$subj_id)
```


## Item flags

```{r}
df2 <- read_excel("../dat/Item_Info.xlsx", sheet = "Form1", na = 'NA')

item_flag_df <- df2 %>%
  filter(FormID == 'form1') %>%
  rename(item_id = ItemID,
         item_flag = Flagged) %>%
  select(item_id, item_flag) %>%
  filter(grepl("score.",item_id)) %>%
  mutate(item_id = str_replace(item_id, 'score.', '')) %>%
  arrange(item_flag)
  
```

create order of items based on the above flag order
```{r}
item_order <- as.character(item_flag_df$item_id)
dfres_ordered<- dfres %>% 
  arrange(subj_flag, factor(item_id, levels = item_order ))

df<- dfres_ordered %>% left_join(item_flag_df, by='item_id')

```


## Save complete reodered dataset
The final response binary data 
```{r}
final_response_df <- df %>%
  select(subj_id, subj_flag, item_id, res) %>%
  spread(item_id, res) %>%
  select(subj_id, subj_flag, item_order) %>%
  arrange(subj_flag)


write_csv(final_response_df, "../dat/clean_iri_data.csv")

head(final_response_df)

```

The final flag indicators data 
```{r}
final_flag_df <- df %>%
  select(subj_id, item_id, item_flag) %>%
  spread(item_id, item_flag) %>%
  left_join(df %>% select(subj_id, subj_flag) %>% distinct(), by ='subj_id') %>%
    select(subj_id, subj_flag, item_order) %>%
  arrange(subj_flag)

write_csv(final_flag_df, "../dat/clean_iri_flag_data.csv")
head(final_flag_df)
```

Check that the columns of the two datasets correspond correctly
```{r}
names(final_response_df) == names(final_flag_df)
```

### Subsample the data

```{r}
clean_items_df <- df %>% filter(item_flag == 0) %>% distinct(item_id)
clean_items <- unique(clean_items_df$item_id)


flagged_items_df <- df %>% filter(item_flag == 1) %>% distinct(item_id)
flagged_items <- unique(flagged_items_df$item_id)
```

## Construct Final Dataset
Sample 500 non-compromised subjects and all the flagged subjects. 
```{r}
set.seed(4)
final_subj_ids <- c(sample(clean_subj, 500), flagged_subj)
final_item_ids <- c(sample(clean_items, 50), sample(flagged_items, 20))

final_item_ids_ordered <- item_order[item_order%in% final_item_ids]

subsample_final_response_df <- final_response_df %>%
  filter(subj_id %in% final_subj_ids) %>%
  select(subj_id, subj_flag, final_item_ids_ordered)
write_csv(subsample_final_response_df, "../dat/clean_sample_iri_data.csv")
head(subsample_final_response_df)


subsample_final_flag_df <- final_flag_df %>%
   filter(subj_id %in% final_subj_ids) %>%
  select(subj_id, subj_flag, final_item_ids_ordered)

write_csv(subsample_final_flag_df, "../dat/clean_sample_iri_flag_data.csv")
head(subsample_final_flag_df)
```

